name: PR Checks

on:
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        working-directory: packages/core
        run: pnpm run build

      - name: Run tests
        working-directory: packages/core
        run: pnpm run test

  package-size:
    name: Package Size
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        working-directory: packages/core
        run: pnpm run build

      - name: Calculate package size
        id: size
        working-directory: packages/core
        run: |
          REPORT="## ðŸ“¦ Package Size Report"
          REPORT="${REPORT}\n"

          # Total dist size
          TOTAL=$(du -sh dist | cut -f1)
          REPORT="${REPORT}\n**Total dist size:** \`$TOTAL\`"
          REPORT="${REPORT}\n"

          # Individual file sizes
          REPORT="${REPORT}\n| File | Size | Gzipped |"
          REPORT="${REPORT}\n|------|------|---------|"

          for file in dist/*.js dist/*.cjs; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file" | xargs)
              GZIP=$(gzip -c "$file" | wc -c | xargs)
              SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc)
              GZIP_KB=$(echo "scale=2; $GZIP / 1024" | bc)
              REPORT="${REPORT}\n| \`$(basename $file)\` | ${SIZE_KB} kB | ${GZIP_KB} kB |"
            fi
          done

          REPORT="${REPORT}\n"

          # Simulated pack size (what npm would publish)
          pnpm pack --pack-destination /tmp 2>&1
          TARBALL=$(ls -1 /tmp/felixfern-tunnel-fn-*.tgz 2>/dev/null | head -1)
          if [ -f "$TARBALL" ]; then
            TARBALL_SIZE=$(wc -c < "$TARBALL" | xargs)
            TARBALL_KB=$(echo "scale=2; $TARBALL_SIZE / 1024" | bc)
            REPORT="${REPORT}\n**Packed tarball size:** \`${TARBALL_KB} kB\`"
          fi

          # Write to step summary
          echo -e "$REPORT" >> $GITHUB_STEP_SUMMARY

          # Write to file for the comment step
          echo -e "$REPORT" > /tmp/size-report.md

          # Print to logs too
          echo "=== Package Size Report ==="
          echo "Total dist: $TOTAL"
          ls -lh dist/*.js dist/*.cjs 2>/dev/null
          if [ -f "$TARBALL" ]; then
            echo "Packed tarball: ${TARBALL_KB} kB"
          fi

      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/size-report.md', 'utf8');
            const marker = '<!-- package-size-report -->';
            const commentBody = `${marker}\n${body}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }
